#cloud-config
## template: jinja
hostname: {{ cfg.hostname }}
manage_etc_hosts: true

{% if cfg.http_proxy %}
apt:
  http_proxy: "{{ cfg.http_proxy }}"
  https_proxy: "{{ cfg.https_proxy }}"
{% endif %}

users:
  - name: {{ cfg.username }}
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
    passwd: "{{ password_hash | default('') }}"

package_update: true
package_upgrade: true
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg2
  - software-properties-common
  - python3
  - python3-pip
  - openjdk-21-jdk
  - npm

write_files:
{% if cfg.http_proxy %}
  - path: /etc/profile.d/proxy.sh
    permissions: '0644'
    content: |
      export http_proxy="{{ cfg.http_proxy }}"
      export https_proxy="{{ cfg.https_proxy }}"
      export no_proxy="{{ cfg.no_proxy }}"
{% endif %}
{% if cfg.http_proxy %}
  - path: /etc/apt/apt.conf.d/95proxies
    permissions: '0644'
    content: |
      Acquire::http::Proxy "{{ cfg.http_proxy }}";
      Acquire::https::Proxy "{{ cfg.https_proxy }}";
{% endif %}
  - path: /usr/lib/binfmt.d/WSLInterop.conf
    permissions: '0644'
    content: |
      :WSLInterop:M::MZ::/init:PF
  - path: /etc/wsl.conf
    permissions: '0644'
    content: |
      [boot]
      systemd=true
      [automount]
      options = "metadata"
      [interop]
      appendWindowsPath = true
      [user]
      default={{ cfg.username }}

runcmd:
{% if cfg.http_proxy %}
  - git config --system http.proxy "{{ cfg.http_proxy }}"
  - git config --system https.proxy "{{ cfg.https_proxy }}"
{% endif %}
  - curl -fsSL https://get.docker.com | sh
  - usermod -aG docker {{ cfg.username }}
  - systemctl enable docker
  - systemctl start docker
  - apt install -y docker-compose-plugin
  - snap install microk8s --classic
  - usermod -a -G microk8s {{ cfg.username }}
  - mkdir -p /home/{{ cfg.username }}/.kube
  - microk8s status --wait-ready
  - microk8s config > /home/{{ cfg.username }}/.kube/config
  - chown -R {{ cfg.username }}:{{ cfg.username }} /home/{{ cfg.username }}/.kube
  - snap install kubectl --classic

final_message: "âœ… cloud-init finished on {{ cfg.hostname }}"
