#cloud-config
## template: jinja
hostname: {{ profile.hostname }}
manage_etc_hosts: true

{% if profile.http_proxy %}
apt:
  http_proxy: "{{ profile.http_proxy }}"
  https_proxy: "{{ profile.https_proxy }}"
{% endif %}

users:
  - name: {{ profile.username }}
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
    passwd: "{{ password_hash | default('') }}"

package_update: true
package_upgrade: true
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg2
  - software-properties-common
  - python3
  - python3-pip
  - openjdk-21-jdk
  - npm

write_files:
{% if profile.http_proxy %}
  - path: /etc/profile.d/proxy.sh
    permissions: '0644'
    content: |
      export http_proxy="{{ profile.http_proxy }}"
      export https_proxy="{{ profile.https_proxy }}"
      export no_proxy="{{ profile.no_proxy }}"
{% endif %}
{% if profile.http_proxy %}
  - path: /etc/apt/apt.conf.d/95proxies
    permissions: '0644'
    content: |
      Acquire::http::Proxy "{{ profile.http_proxy }}";
      Acquire::https::Proxy "{{ profile.https_proxy }}";
{% endif %}
  - path: /usr/lib/binfmt.d/WSLInterop.conf
    permissions: '0644'
    content: |
      :WSLInterop:M::MZ::/init:PF
  - path: /etc/wsl.conf
    permissions: '0644'
    content: |
      [boot]
      systemd=true
      [automount]
      options = "metadata"
      [interop]
      appendWindowsPath = true
      [user]
      default={{ profile.username }}

runcmd:
{% if profile.http_proxy %}
  - git config --system http.proxy "{{ profile.http_proxy }}"
  - git config --system https.proxy "{{ profile.https_proxy }}"
{% endif %}
  - curl -fsSL https://get.docker.com | sh
  - usermod -aG docker {{ profile.username }}
  - systemctl enable docker
  - systemctl start docker
  - apt install -y docker-compose-plugin
  - snap install microk8s --classic
  - usermod -a -G microk8s {{ profile.username }}
  - mkdir -p /home/{{ profile.username }}/.kube
  - microk8s status --wait-ready
  - microk8s config > /home/{{ profile.username }}/.kube/config
  - chown -R {{ profile.username }}:{{ profile.username }} /home/{{ profile.username }}/.kube
  - snap install kubectl --classic

final_message: "âœ… cloud-init finished on {{ profile.hostname }}"
